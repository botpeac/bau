<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Viewer with Sorting & Search</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

    <link rel="manifest" href="manifest.json" />

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Viewer" />
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png" />

    <meta name="format-detection" content="telephone=no" />

    <meta name="theme-color" content="#f9f9f9" media="(prefers-color-scheme: light)" />
    <meta name="theme-color" content="#2f2f2f" media="(prefers-color-scheme: dark)" />

    <style>
        :root {
            --background-color: #f9f9f9; /* Default light mode background */
            --text-color: #333; /* Default light mode text */
            --post-background: #fff;
            --post-border: #ddd;
            --control-background: #eee;
            --control-text: #333;
            --link-color: blue;
            --button-background: #007bff;
            --button-text: #fff;
            --button-disabled-background: #6c757d;
            --button-disabled-text: #fff;
            --select-border: #ccc;
            --input-border: #ccc;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: sans-serif;
            margin: 0;
            padding: 16px;
            line-height: 1.5;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        h1, h2, h3 {
            color: var(--text-color);
        }

        .mode-selector {
            margin-bottom: 16px;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .post {
            background-color: var(--post-background);
            border: 1px solid var(--post-border);
            padding: 16px;
            margin-bottom: 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .post h3 {
            margin-top: 0;
            margin-bottom: 8px;
        }

        .controls {
            background-color: var(--control-background);
            padding: 16px;
            margin-bottom: 16px;
            border-radius: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            transition: background-color 0.3s ease;
        }

        .controls label,
        .controls input,
        .controls button,
        .controls select {
            margin-bottom: 8px;
        }

        .toggle {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        input[type="file"] {
            padding: 8px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
        }

        button {
            padding: 8px 12px;
            background-color: var(--button-background);
            color: var(--button-text);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:disabled {
            background-color: var(--button-disabled-background);
            color: var(--button-disabled-text);
            cursor: not-allowed;
        }

        select {
            padding: 8px;
            border: 1px solid var(--select-border);
            border-radius: 4px;
            background-color: #fff; /* Ensure white background for select in dark mode */
            color: var(--text-color);
        }

        input[type="text"] {
            padding: 8px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            background-color: #fff; /* Ensure white background for input in dark mode */
            color: var(--text-color);
        }

        a {
            color: var(--link-color);
            transition: color 0.3s ease;
        }

        .pagination {
            display: flex;
            gap: 16px;
            margin-top: 16px;
            margin-bottom: 32px;
            align-items: center;
            justify-content: center;
        }

        .pagination button {
            padding: 8px 16px;
        }

        #postCount {
            margin-bottom: 16px;
            font-style: italic;
            color: var(--text-color);
        }

        /* Dark mode based on system preference */
        @media (prefers-color-scheme: dark) {
            :root {
                --background-color: #2f2f2f;
                --text-color: #eee;
                --post-background: #333;
                --post-border: #555;
                --control-background: #444;
                --control-text: #eee;
                --link-color: lightskyblue;
                --button-background: #2188ff;
                --button-text: #fff;
                --select-border: #555;
                --input-border: #555;
            }
            select, input[type="text"] {
                background-color: #333;
                color: #eee;
            }
        }

        /* Dark Gray mode (applied by the .dark-gray class) */
        .dark-gray {
            --background-color: #333;
            --text-color: #ddd;
            --post-background: #444;
            --post-border: #666;
            --control-background: #555;
            --control-text: #ddd;
            --link-color: skyblue;
            --button-background: #3498db;
        }
        .dark-gray select, .dark-gray input[type="text"] {
            background-color: #444;
            color: #ddd;
        }

        /* True Black mode (applied by the .true-black class) */
        .true-black {
            --background-color: #000;
            --text-color: #ccc;
            --post-background: #111;
            --post-border: #333;
            --control-background: #222;
            --control-text: #ccc;
            --link-color: #80cfff;
            --button-background: #1e90ff;
        }
        .true-black select, .true-black input[type="text"] {
            background-color: #111;
            color: #ccc;
        }
    </style>
</head>
<body>

    <h1>Viewer</h1>

    <div class="mode-selector">
        <input type="radio" id="mode-light" name="colorMode" value="light" checked />
        <label for="mode-light" title="Light mode">Light</label>
        <input type="radio" id="mode-darkgray" name="colorMode" value="dark-gray" />
        <label for="mode-darkgray" title="Dark Gray mode">Dark Gray</label>
        <input type="radio" id="mode-trueblack" name="colorMode" value="true-black" />
        <label for="mode-trueblack" title="True Black mode">True Black</label>
    </div>

    <div class="controls">
        <input type="file" id="fileInput" />
        <button id="loadButton" disabled>Done</button>
        <label class="toggle"><input type="checkbox" id="showTextPosts" checked> Show Text Posts</label>
        <label class="toggle"><input type="checkbox" id="showLinkPosts" checked> Show Link Posts</label>
        <label class="toggle">
            Sort by:
            <select id="sortBy">
                <option value="none">None</option>
                <option value="textLength">Text Length</option>
                <option value="scoreAsc">Score ↑</option>
                <option value="scoreDesc">Score ↓</option>
                <option value="dateAsc">Date ↑</option>
                <option value="dateDesc">Date ↓</option>
            </select>
        </label>
        <label class="toggle">
            Font Size:
            <select id="fontSizeSelect">
                <option value="14px">14px</option>
                <option value="16px" selected>16px</option>
                <option value="18px">18px</option>
                <option value="20px">20px</option>
                <option value="22px">22px</option>
            </select>
        </label>
        <label class="toggle">
            Line Spacing:
            <select id="lineHeightSelect">
                <option value="1.2">1.2</option>
                <option value="1.5" selected>1.5</option>
                <option value="1.8">1.8</option>
                <option value="2">2</option>
            </select>
        </label>
        <input type="text" id="searchInput" placeholder="Search by title, content or author..." />
    </div>

    <div id="postCount"></div>
    <div id="content"></div>

    <div class="pagination">
        <button id="prevBtn" disabled>Previous</button>
        <span id="pageInfo">Page 0</span>
        <button id="nextBtn" disabled>Next</button>
    </div>

    <script>
        const body = document.body;
        const modeRadios = document.querySelectorAll('input[name="colorMode"]');

        function setTheme(mode) {
            body.classList.remove('dark-gray', 'true-black');
            if (mode === 'dark-gray') {
                body.classList.add('dark-gray');
                localStorage.setItem('colorMode', 'dark-gray');
            } else if (mode === 'true-black') {
                body.classList.add('true-black');
                localStorage.setItem('colorMode', 'true-black');
            } else {
                localStorage.removeItem('colorMode'); // Use system default
            }
        }

        // Event listeners for manual mode switching
        modeRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                setTheme(radio.value);
            });
        });

        // Check for saved theme or system preference on load
        document.addEventListener('DOMContentLoaded', () => {
            const savedMode = localStorage.getItem('colorMode');
            if (savedMode) {
                const radio = document.getElementById(`mode-${savedMode}`);
                if (radio) {
                    radio.checked = true;
                    setTheme(savedMode);
                }
            }
        });

        const fileInput = document.getElementById('fileInput');
        const loadButton = document.getElementById('loadButton');
        const contentDiv = document.getElementById('content');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const pageInfo = document.getElementById('pageInfo');
        const showTextPosts = document.getElementById('showTextPosts');
        const showLinkPosts = document.getElementById('showLinkPosts');
        const sortBy = document.getElementById('sortBy');
        const searchInput = document.getElementById('searchInput');
        const fontSizeSelect = document.getElementById('fontSizeSelect');
        const lineHeightSelect = document.getElementById('lineHeightSelect');
        const postCountDiv = document.getElementById('postCount');

        let rawData = [];
        let filteredData = [];
        let currentPage = 1;
        const pageSize = 10;
        let lastScrollY = 0;

        fileInput.addEventListener('change', () => {
            loadButton.disabled = !fileInput.files[0];
        });

        loadButton.addEventListener('click', () => {
            const file = fileInput.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                const lines = e.target.result.split('\n').filter(line => line.trim());
                rawData = [];
                let skipped = 0;
                for (const line of lines) {
                    try {
                        rawData.push(JSON.parse(line));
                    } catch { skipped++; }
                }
                contentDiv.innerHTML = skipped > 0 ? `⚠️ Skipped ${skipped} malformed entries.<br><br>` : '';
                applyFilters();
            };
            reader.readAsText(file);
        });

        function applyFilters() {
            const showText = showTextPosts.checked;
            const showLink = showLinkPosts.checked;
            const query = searchInput.value.toLowerCase();
            filteredData = rawData.filter(item => {
                const isText = ('is_self' in item) ? item.is_self : !!item.selftext;
                const isLink = ('is_self' in item) ? !item.is_self : (!!item.url && !item.selftext);
                const isComment = 'body' in item && !('title' in item);
                const showType = (isText && showText) || (isLink && showLink) || (isComment && showText);
                if (!showType) return false;
                const content = `${item.title || ''} ${item.selftext || ''} ${item.body || ''} ${item.author || ''}`.toLowerCase();
                return content.includes(query);
            });
            applySorting();
            currentPage = 1;
            renderPage(currentPage);
        }

        function applySorting() {
            const mode = sortBy.value;
            filteredData.sort((a, b) => {
                const lenA = (a.selftext || a.body || '').length;
                const lenB = (b.selftext || b.body || '').length;
                const scoreA = a.score || 0;
                const scoreB = b.score || 0;
                const dateA = a.created_utc || a.created || 0;
                const dateB = b.created_utc || b.created || 0;
                switch (mode) {
                    case 'textLength': return lenB - lenA;
                    case 'scoreAsc': return scoreA - scoreB;
                    case 'scoreDesc': return scoreB - scoreA;
                    case 'dateAsc': return dateA - dateB;
                    case 'dateDesc': return dateB - dateA;
                    default: return 0;
                }
            });
        }

        function updatePostCount() {
            postCountDiv.textContent = `Showing ${filteredData.length} post${filteredData.length !== 1 ? 's' : ''}`;
        }

        function renderSinglePost(post) {
            lastScrollY = window.scrollY;
            contentDiv.innerHTML = '';
            const div = document.createElement('div');
            div.className = 'post';
            const dateStr = new Date((post.created_utc || post.created || 0) * 1000).toLocaleString();
            if (post.body && !post.title) {
                div.innerHTML = `
                    <p><strong>Author:</strong> ${post.author ||
